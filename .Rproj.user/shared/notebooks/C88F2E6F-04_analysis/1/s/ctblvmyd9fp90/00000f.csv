"0","zprop_compare_weighted <- function(data_old, data_new, stratum, value_stratum, name, weights, strict = F){"
"0","  names_new <- names(data_new)"
"0","  not_in_new <- names_new[which(!(name %in% names_new))]"
"0","i <- 1"
"0","table_old <- data.frame()"
"0","for (i in 1:length(name)) {"
"0","  ni <- name[i]"
"0","  ti <- data_old %>% "
"0","    group_by(!!sym(ni)) %>% filter(!!sym(stratum) == paste0(value_stratum)) %>%"
"0","    filter(!is.na(!!sym(ni))) %>%"
"0","    filter(!!sym(ni) != 'refuse') %>%"
"0","    dplyr::summarize(wtn = sum(!!sym(weights)), n = n()) %>%"
"0","    mutate(prop = wtn/sum(wtn), base = sum(wtn), cnt = sum(n))%>%"
"0","    mutate(varnam = ni)"
"0","  names(ti) <- c(""var"", ""wtn"", ""n"", ""prop"", ""base_w"", ""count"", ""nam"")"
"0","  table_old <- rbind(table_old, ti)"
"0","}"
"0","table_cl_old <- table_old %>% filter(var != ""0"") %>% filter(!is.na(var)) %>%"
"0","  mutate(var_id = paste0(nam, ""."", var))"
"0","i <- 1"
"0","table_new <- data.frame()"
"0","for (i in 1:length(name)) {"
"0","  ni <- name[i]"
"0","  ti <- data_new %>% "
"0","    group_by(!!sym(ni)) %>% filter(!!sym(stratum) == paste0(value_stratum)) %>%"
"0","    filter(!is.na(!!sym(ni))) %>%"
"0","    filter(!!sym(ni) != 'refuse') %>%"
"0","    dplyr::summarize(wtn = sum(!!sym(weights)), n = n()) %>%"
"0","    mutate(prop = wtn/sum(wtn), base = sum(wtn), cnt = sum(n))%>%"
"0","    mutate(varnam = ni)"
"0","  names(ti) <- c(""var"", ""wtn"", ""n"", ""prop"", ""base_w"", ""count"", ""nam"")"
"0","  table_new <- rbind(table_new, ti)"
"0","}"
"0","table_cl_new <- table_new %>% filter(var != ""0"") %>% filter(!is.na(var)) %>%"
"0","  mutate(var_id = paste0(nam, ""."", var))"
"0","table_cl_compare <- merge(table_cl_old, table_cl_new, by = ""var_id"", all = T)"
"0","names(table_cl_compare) <- c(""var.id"", ""var.old"", ""wtn.old"", ""n.old"", ""prop.old"", ""base.old"", ""base_nw.old"",""nam.old"", ""var.new"", ""wtn.new"", ""n.new"", ""prop.new"", ""base.new"", ""base_nw.new"", ""nam.new"")"
"0",""
"0","#Dealing with NA issues"
"0",""
"0","  table_cl_compare$nam.old[is.na(table_cl_compare$nam.old)] <- table_cl_compare$nam.new[is.na(table_cl_compare$nam.old)]"
"0","  "
"0","    table_cl_compare$nam.new[is.na(table_cl_compare$nam.new)] <- table_cl_compare$nam.old[is.na(table_cl_compare$nam.new)]"
"0",""
"0","table_cl_compare$to_split <- table_cl_compare$nam.old"
"0","  "
"0","table_cl_compare <- separate(table_cl_compare, col = to_split, into = c(""indctr"", ""item""), sep =""\\."")"
"0",""
"0","  table_cl_compare <- table_cl_compare %>% group_by(indctr) %>% fill(base_nw.old, .direction  = ""down"") %>% fill(base_nw.old, .direction  = ""up"") %>% ungroup()"
"0","  table_cl_compare <- table_cl_compare %>% group_by(indctr) %>% fill(base.old, .direction  = ""down"") %>% fill(base.old, .direction  = ""up"") %>% ungroup()"
"0","  table_cl_compare <- table_cl_compare %>% group_by(indctr) %>% fill(base_nw.new, .direction  = ""down"") %>% fill(base_nw.new, .direction  = ""up"") %>% ungroup()"
"0","  table_cl_compare <- table_cl_compare %>% group_by(indctr) %>% fill(base.new) %>% fill(base_nw.old, .direction  = ""down"") %>% fill(base.new, .direction  = ""up"") %>% ungroup()"
"0",""
"0",""
"0","table_cl_compare$prop.old[is.na(table_cl_compare$prop.old)] <- 0"
"0","table_cl_compare$prop.new[is.na(table_cl_compare$prop.new)] <- 0"
"0",""
"0","table_cl_compare$wtn.old[is.na(table_cl_compare$wtn.old)] <- 0"
"0","table_cl_compare$wtn.new[is.na(table_cl_compare$wtn.new)] <- 0"
"0",""
"0","for (i in 1:nrow(table_cl_compare)){"
"0","pt <- prop.test(x = c(table_cl_compare$wtn.old[i], table_cl_compare$wtn.new[i]), n = c(table_cl_compare$base.old[i], table_cl_compare$base.new[i]))"
"0","table_cl_compare$prp_tst_p[i] <- pt$p.value"
"0","}"
"0","table_cl_compare$sig <- ifelse(table_cl_compare$prp_tst_p < 0.05, ""Significant diff."", ""Not significant"")"
"0","table_cl_compare$stratum <- paste0(value_stratum)"
"0",""
"0",""
"0","table_cl_compare_final <- table_cl_compare %>% "
"0","  filter(case_when(strict == T ~ (prop.old*n.new >= 10 & prop.old*n.old >=10),"
"0","                   strict == F ~ (base_nw.old >= 30 & base_nw.new >=30)))"
"0",""
"0","table_cl_compare_final <- table_cl_compare_final %>% filter(!(nam.old %in% not_in_new))"
"0",""
"0","if(nrow(table_cl_compare_final) < nrow(table_cl_compare)){"
"0","  ss_vars <- table_cl_compare$var.id[which(!(table_cl_compare$var.id %in% table_cl_compare_final$var.id))]"
"0","  warning(paste0(""Too small sample size. Variables that were removed from the analysis"", ss_vars))"
"0","}"
"0",""
"0","return(table_cl_compare_final)"
"0","}"
